<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.scoula.house.mapper.LhRentalHouseMapper">
    <resultMap id="LhRentalHouseResultMap" type="org.scoula.house.domain.LhRentalHouseVO">
        <!-- 임대주택 기본 정보 -->
        <id property="lhRentalId" column="lh_rental_id"/>
        <result property="panId" column="pan_id"/>
        <result property="lccNtNm" column="lcc_nt_nm"/>
        <result property="lgdnAdr" column="lgdn_adr"/>
        <result property="lgdnDtlAdr" column="lgdn_dtl_adr"/>
        <result property="ddoAr" column="ddo_ar"/>
        <result property="hshCnt" column="hsh_cnt"/>
        <result property="htnFmlaDesc" column="htn_fmla_desc"/>
        <result property="mvinXpcYm" column="mvin_xpc_ym"/>

        <!-- 공고 정보 (별도 쿼리로 조회) -->
        <association property="notice"
                     javaType="org.scoula.lh.domain.LhNoticeVO"
                     column="pan_id"
                     select="selectNoticeByPanId"/>

        <!-- 신청 정보 (별도 쿼리로 조회) -->
        <association property="apply"
                     javaType="org.scoula.lh.domain.rental.LhRentalApplyVO"
                     column="{panId=pan_id, lccNtNm=lcc_nt_nm}"
                     select="selectApplyByPanIdAndName"/>

        <!-- 공고 첨부파일 (별도 쿼리로 조회) -->
        <collection property="noticeAttList"
                    javaType="org.scoula.lh.domain.NoticeAttVO"
                    column="pan_id"
                    select="selectNoticeAttachmentsByPanId"/>


        <!-- 첨부파일 목록 (별도 쿼리로 조회) -->
        <collection property="lhRentalAttList"
                    ofType="org.scoula.lh.domain.rental.LhRentalAttVO"
                    column="{panId=pan_id, locNtNm=lcc_nt_nm}"
                    select="selectAttachmentsByPanIdAndName"/>
    </resultMap>

    <!-- 메인 쿼리: 임대주택 기본 정보 조회 -->
    <select id="get" parameterType="int" resultMap="LhRentalHouseResultMap">
        SELECT
            lh_rental_id,
            pan_id,
            lcc_nt_nm,
            lgdn_adr,
            lgdn_dtl_adr,
            ddo_ar,
            hsh_cnt,
            htn_fmla_desc,
            mvin_xpc_ym
        FROM LH_rental
        WHERE lh_rental_id = #{lhRentalId}
    </select>

    <!-- 별도 쿼리 1: 공고 정보 조회 -->
    <select id="selectNoticeByPanId" parameterType="String" resultType="org.scoula.lh.domain.LhNoticeVO">
        SELECT
            pan_id as panId,
            upp_ais_tp_cd as uppAisTpCd,
            ais_tp_cd_nm as aisTpCdNm,
            pan_nm as panNm,
            cnp_cd_nm as cnpCdNm,
            pan_ss as panSs,
            all_cnt as allCnt,
            dtl_url as dtlUrl,
            spl_inf_tp_cd as splInfTpCd,
            ccr_cnnt_sys_ds_cd as ccrCnntSysDsCd,
            ais_tp_cd as aisTpCd
        FROM LH_notice
        WHERE pan_id = #{panId}
    </select>

    <select id="selectNoticeAttachmentsByPanId" parameterType="String" resultType="org.scoula.lh.domain.NoticeAttVO">
        SELECT
            *
        FROM LH_notice_att
        WHERE pan_id = #{panId}
    </select>

    <!-- 별도 쿼리 2: 신청 정보 조회 -->
    <select id="selectApplyByPanIdAndName" resultType="org.scoula.lh.domain.rental.LhRentalApplyVO">
        SELECT
            lh_rental_id as lhRentalId,
            pan_id as panId,
            sbd_lgo_nm as sbdLgoNm,
            sbsc_acp_st_dt as sbscAcpStDt,
            sbsc_acp_clsg_dt as sbscAcpClsgDt,
            ppr_sbm_ope_anc_dt as pprSbmOpeAncDt,
            ppr_acp_st_dt as pprAcpStDt,
            ppr_acp_clsg_dt as pprAcpClsgDt,
            pzwr_anc_dt as pzwrAncDt,
            ctrt_st_dt as ctrtStDt,
            ctrt_ed_dt as ctrtEdDt
        FROM LH_rental_apply
        WHERE pan_id = #{panId}
          AND sbd_lgo_nm = #{lccNtNm}
    </select>

    <!-- 별도 쿼리 3: 첨부파일 목록 조회 -->
    <select id="selectAttachmentsByPanIdAndName" resultType="org.scoula.lh.domain.rental.LhRentalAttVO">
        SELECT
            LH_rental_att_id as lhRentalAttId,
            pan_id as panId,
            loc_nt_nm as locNtNm,
            ls_spl_inf_upl_fl_ds_cd_nm as lsSplInfUplFlDsCdNm,
            cmn_ahfl_nm as cmnAhflNm,
            ahfl_url as ahflUrl
        FROM LH_rental_att
        WHERE pan_id = #{panId}
          AND loc_nt_nm = #{locNtNm}
    </select>
</mapper>