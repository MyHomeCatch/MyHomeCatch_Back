<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.scoula.lh.danzi.mapper.PersonalSummaryMapper">

    <!-- 결과 매핑: 중첩 DTO + Map 키 매핑 -->
    <resultMap id="PersonalizedCardMap" type="org.scoula.lh.danzi.dto.http.PersonalizedCardDTO">
        <result property="userId"    column="user_id"/>
        <result property="danziId"   column="danzi_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>

        <association property="eligibilityResultDTO"
                     javaType="org.scoula.lh.danzi.dto.EligibilityResultDTO">
            <result property="overallStatus"  column="overall_status"/>
            <result property="homelessStatus" column="homeless_status"/>
            <result property="incomeStatus"   column="income_status"/>
            <result property="assetStatus"    column="asset_status"/>
            <result property="carStatus"      column="car_status"/>
            <result property="types" column="types"
                    typeHandler="org.scoula.summary.parsing.JsonStringListTypeHandler"/>
            <!-- notes(JSON) -->
            <result property="notes" column="notes"
                    typeHandler="org.scoula.summary.parsing.JsonStringListTypeHandler"/>
        </association>
    </resultMap>

    <!-- 공통 컬럼 -->
    <sql id="personalizedCardColumns">
    user_id,
    danzi_id,
    overall_status,
    homeless_status,
    income_status,
    asset_status,
    car_status,
    notes,
    types,
    created_at,
    updated_at
    </sql>



<insert id="upsert" parameterType="org.scoula.lh.danzi.dto.http.PersonalizedCardDTO">
    INSERT INTO personalized_card
    (user_id,
     danzi_id,
     overall_status,
     homeless_status,
     income_status,
     asset_status,
     car_status,
     types,
     notes)
    VALUES (#{userId},
            #{danziId},
            #{eligibilityResultDTO.overallStatus},
            #{eligibilityResultDTO.homelessStatus},
            #{eligibilityResultDTO.incomeStatus},
            #{eligibilityResultDTO.assetStatus},
            #{eligibilityResultDTO.carStatus},
            #{eligibilityResultDTO.types, typeHandler=org.scoula.summary.parsing.JsonStringListTypeHandler},
                #{eligibilityResultDTO.notes, typeHandler=org.scoula.summary.parsing.JsonStringListTypeHandler})
    ON DUPLICATE KEY UPDATE overall_status  = VALUES(overall_status),
                            homeless_status = VALUES(homeless_status),
                            income_status   = VALUES(income_status),
                            asset_status    = VALUES(asset_status),
                            car_status      = VALUES(car_status),
                            notes           = VALUES(notes),
                            types            = values(types),
                            updated_at      = CURRENT_TIMESTAMP
</insert>



    <!-- 단건 조회: userId + danziId -->
    <select id="get" resultMap="PersonalizedCardMap" parameterType="map">
        SELECT
        <include refid="personalizedCardColumns"/>
        FROM personalized_card
        WHERE user_id = #{userId}
        AND danzi_id = #{danziId}
        LIMIT 1
    </select>

    <!-- UserId 로 조회 -->
    <select id="getAllByUserId" resultMap="PersonalizedCardMap" parameterType="int">
        SELECT
        <include refid="personalizedCardColumns"/>
        FROM personalized_card
        WHERE user_id = #{userId}
        ORDER BY updated_at DESC
    </select>

</mapper>